<!DOCTYPE html><!--[if lte IE 8]>
<html lang="en" class="lte-ie8">
<![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en">
<!--<![endif]--><head><meta charset="utf-8"><title>April 12, 2017</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/diary/styles/global.css"><link rel="stylesheet" href="/diary/styles/tomorrow.css"><link rel="stylesheet" href="/diary/styles/diary.css"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63818301-1', 'auto');
ga('send', 'pageview');</script></head><body><header class="header"><div class="index"><a href="/diary/">Index</a></div><h1>April 12, 2017</h1></header><div class="content"><div class="diary"><h2 id="linux-system-programming-">Linux System Programming 读书笔记</h2>
<h3 id="-">第二章</h3>
<p>第二章主要讲的是文件I/O。因为Unix里有一个理念就是<strong>万物都是文件</strong>，所以文件I/O也不仅仅是用在文件的读写上，比如socket和pipe等等的读写也是用文件I/O的API。因此这块内容是一个重点。</p>
<p>API的使用的话，还是比较简单清晰的。引起我注意的有几点：</p>
<p>首先是错误处理，不过这个不仅仅是文件相关的，这是Unix上通用的错误处理方式。具体来说就是API在发生错误时会返回-1，然后<strong>错误号会存在一个叫<code>errno</code>的全局变量里面</strong>。根据这个错误号，可以查表得知错误原因的字符串。这里需要注意的是这个错误变量是全局公用的，因此有时需要将其的值保存到临时变量里，以避免被其他发生错误的API修改。</p>
<p>然后是文件的缓存。<code>write</code>这个API，<strong>会将写入的内容存在内核的buffer里，然后立刻返回。然后操作系统会在合适的时刻把这个buffer写到磁盘里。这种机制叫write back。</strong>具体的实现涉及内核具体的设计（其实学校里讲操作系统就会讲到这些，但只是一个抽象的算法描述）。大致就是，内存的page是磁盘的映像，两者会进行同步。之所以这样设计其实很简单，和计算机系统里所有的缓存存在的道理是一样的，就是局部性原理。</p>
<p>这里比较巧妙的就是。如果你用<code>write</code>写入了数据，然后立即调用<code>read</code>读取文件，如果这个时候内核的buffer还没有同步到磁盘，那<code>read</code>会直接从内核的buffer里面读取最新的数据。</p>
<p>所以这一层缓存对于API调用者是不可见的。我也是看了书才知道平时用的I/O其实被缓存了。</p>
</div></div><footer class="footer"><address class="author">Copyright &copy;<a rel="author" href="https://github.com/zxc0328" class="author-name">ccnuzindex</a>-<a href="https://github.com/zxc0328/diary-content.git" class="source-repo">Source</a></address><p>Generated by<a href="https://github.com/joyeecheung/diary" class="site-repo">Joyee Cheung&#39;s diary generator</a></p></footer></body></html>