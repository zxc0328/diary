<!DOCTYPE html><!--[if lte IE 8]>
<html lang="en" class="lte-ie8">
<![endif]-->
<!--[if gt IE 8]><!-->
<html lang="en">
<!--<![endif]--><head><meta charset="utf-8"><title>September 22, 2017</title><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="stylesheet" href="/diary/styles/global.css"><link rel="stylesheet" href="/diary/styles/tomorrow.css"><link rel="stylesheet" href="/diary/styles/diary.css"></head><body><header class="header"><div class="index"><a href="/diary/">Index</a></div><h1>September 22, 2017</h1></header><div class="content"><div class="diary"><h2 id="vue-community-diary-directive-hooks-not-called-when-component-root-element-change-6513-why-vue-need-to-update-parent-placeholder-node-element-when-component-root-element-replaced-">Vue community diary: directive hooks not called when component root element change (#6513), Why Vue need to update parent placeholder node element when component root element replaced?</h2>
<h3 id="issue">Issue</h3>
<p>When directive is applied on a component, how to define when it&#39;s &quot;inserted&quot;? The answer is, when its root element is inserted, the inserted hook of the directive will be called.</p>
<p><strong>This is an edge case.</strong> The bug here is directive inserted hook not called when component root element change.</p>
<h3 id="implementation">Implementation</h3>
<p>From the source code, we can know that <strong>when component root element replaced, Vue will update parent placeholder node element, recursively.</strong> THIS IS NEW FOR ME.</p>
<p><em>src/core/vdom/patch.js</em> </p>
<pre><code><span class="hljs-keyword">if</span> (isDef(vnode.<span class="hljs-keyword">parent</span>)) {
  <span class="hljs-comment">// component root element replaced.</span>
  <span class="hljs-comment">// update parent placeholder node element, recursively</span>
  <span class="hljs-keyword">let</span> ancestor = vnode.<span class="hljs-keyword">parent</span>
  <span class="hljs-keyword">const</span> patchable = isPatchable(vnode)
  <span class="hljs-keyword">while</span> (ancestor) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.destroy.length; ++i) {
      cbs.destroy[i](ancestor)
    }
    ancestor.elm = vnode.elm
    <span class="hljs-keyword">if</span> (patchable) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cbs.create.length; ++i) {
        cbs.create[i](emptyNode, ancestor)
      }

    }
    ancestor = ancestor.<span class="hljs-keyword">parent</span>
  }
}
</code></pre><p>So Vue forget to <strong>invoke insert hooks</strong> that may have been merged by create hooks. e.g. for directives that uses the &quot;inserted&quot; hook. </p>
<p><em>src/core/vdom/modules/directives.js</em> </p>
<pre><code><span class="hljs-keyword">if</span> (<span class="hljs-built_in">dirs</span>WithInsert.length) {
    const callInsert = () =&gt; {
      <span class="hljs-keyword">for</span> (<span class="hljs-built_in">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">dirs</span>WithInsert.length; i++) {
        callHook(<span class="hljs-built_in">dirs</span>WithInsert[i], <span class="hljs-string">'inserted'</span>, vnode, oldVnode)
      }
    }
    <span class="hljs-keyword">if</span> (isCreate) {
      mergeVNodeHook(vnode.data.hook || (vnode.data.hook = {}), <span class="hljs-string">'insert'</span>, callInsert)
    } <span class="hljs-keyword">else</span> {
      callInsert()
    }
  }
</code></pre><p>The fix:</p>
<p><em>src/core/vdom/patch.js</em> </p>
<pre><code>// <span class="hljs-comment">#6513</span>
//<span class="hljs-instruction"> invoke </span>insert hooks that may have been merged by create hooks.
// e.g. for directives that uses the <span class="hljs-string">"inserted"</span> hook.<span class="hljs-instruction">
const </span>insert = ancestor.data.hook.insert<span class="hljs-instruction">
if </span>(insert.merged<span class="hljs-function">)</span> {
// start at index 1 to avoid re-invoking component mounted hook
    for<span class="hljs-function"> (</span>let i = 1; i &lt; insert.fns.length; i++<span class="hljs-function">)</span> {
     <span class="hljs-function"> insert.fns[i](</span><span class="hljs-function">)</span>
    }
}
</code></pre><h3 id="thought">Thought</h3>
<p><strong>Why Vue need to update parent placeholder node element when component root element replaced?</strong></p>
</div></div><footer class="footer"><address class="author">Copyright &copy;<a rel="author" href="https://github.com/zindex" class="author-name">Zindex</a>-<a href="https://github.com/zxc0328/diary-content" class="source-repo">Source</a></address><p>Generated by<a href="https://github.com/joyeecheung/diary" class="site-repo">Joyee Cheung&#39;s diary generator</a></p></footer></body></html>